<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Music Realtime (FastAPI)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/vue@2/dist/vue.js"></script>
  <style>
    .queue-thumb{width:64px;height:36px;object-fit:cover;border-radius:.35rem}
  </style>
</head>
<body class="bg-light">
<div id="app" class="container py-4">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h1 class="h4 mb-0">üéµ Reproductor sincronizado</h1>
    <span class="badge" :class="connected?'bg-success':'bg-danger'">{{connected?'WS conectado':'WS desconectado'}}</span>
  </div>

  <!-- Buscador de canciones -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label"><i class="bi bi-search me-1"></i>Buscar m√∫sica en YouTube</label>
          <input v-model="searchQuery" class="form-control" placeholder="Buscar artista, canci√≥n..." @keyup.enter="searchMusic" />
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-success" :disabled="searching" @click="searchMusic">
            <span v-if="searching" class="spinner-border spinner-border-sm me-2"></span>
            <i v-else class="bi bi-search me-1"></i>
            {{ searching ? 'Buscando...' : 'Buscar' }}
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Resultados de b√∫squeda -->
  <div v-if="searchResults.length" class="card shadow-sm mb-3">
    <div class="card-body">
      <h5 class="card-title">
        <i class="bi bi-music-note-list me-2"></i>Resultados de b√∫squeda ({{ searchResults.length }})
        <button class="btn btn-sm btn-outline-secondary float-end" @click="clearSearch">
          <i class="bi bi-x-circle"></i> Cerrar
        </button>
      </h5>
      <div class="list-group">
        <div v-for="song in searchResults" :key="song.id.videoId"
             class="list-group-item list-group-item-action d-flex align-items-center gap-3 py-2">
          <img :src="song.snippet.thumbnails.medium.url"
               class="queue-thumb"
               :alt="song.snippet.title"
               style="width:120px;height:68px">
          <div class="flex-grow-1">
            <div class="fw-bold text-truncate" style="max-width:500px">{{ song.snippet.title }}</div>
            <div class="text-muted small">{{ song.snippet.channelTitle }}</div>
            <div class="text-muted small" v-if="song.duration">{{ mmss(song.duration) }}</div>
          </div>
          <div class="btn-group">
            <button class="btn btn-sm btn-primary"
                    @click="playNow(song.id.videoId)"
                    title="Reproducir ahora">
              <i class="bi bi-play-fill"></i> Reproducir
            </button>
            <button class="btn btn-sm btn-outline-primary"
                    @click="addToQueue(song.id.videoId)"
                    title="Agregar a cola">
              <i class="bi bi-plus-circle"></i> Cola
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agregar por URL (alternativa) -->
  <div class="card shadow-sm mb-3">
    <div class="card-body">
      <div class="row g-2 align-items-end">
        <div class="col-md-8">
          <label class="form-label"><i class="bi bi-link-45deg me-1"></i>O agregar por URL de YouTube</label>
          <input v-model="urlOrId" class="form-control" placeholder="https://www.youtube.com/watch?v=..." @keyup.enter="addAndEnqueue" />
        </div>
        <div class="col-md-4 d-grid">
          <button class="btn btn-primary" :disabled="busy" @click="addAndEnqueue">
            <span v-if="busy" class="spinner-border spinner-border-sm me-2"></span>
            {{ busy ? 'Descargando...' : 'Agregar a cola' }}
          </button>
        </div>
      </div>
      <div v-if="adding.length" class="mt-2 small text-muted">
        <i class="bi bi-cloud-arrow-down me-1"></i>Descargando:
        <span v-for="(x,i) in adding" :key="i" class="badge text-bg-secondary ms-1">{{ x.show }}</span>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Ahora suena</h5>
          <p class="mb-1"><strong>{{ state.current ? state.current.title : '‚Äî' }}</strong></p>
          <p class="text-muted mb-2">{{ state.positionLabel }} / {{ state.durationLabel }}</p>

          <div class="btn-group mb-2" role="group">
            <button class="btn btn-success" @click="wsSend('player:play', {})">Play</button>
            <button class="btn btn-warning" @click="wsSend('player:pause', {})">Pause</button>
            <button class="btn btn-secondary" @click="wsSend('player:next', {})">Next</button>
          </div>

          <div class="row g-2 align-items-center mb-2">
            <div class="col">
              <input type="range" min="0" :max="state.duration || 0" step="1"
                     class="form-range" :value="Math.floor(state.position || 0)"
                     @change="onSeek($event)">
            </div>
            <div class="col-auto">
              <span class="text-muted small">{{ Math.floor(state.position || 0) }}s</span>
            </div>
          </div>

          <div class="d-flex align-items-center gap-2">
            <button class="btn btn-outline-secondary btn-sm" @click="toggleMute">
              <i :class="muted?'bi bi-volume-mute-fill':(volume===0?'bi bi-volume-off':(volume<0.6?'bi bi-volume-down':'bi bi-volume-up'))"></i>
            </button>
            <input type="range" min="0" max="1" step="0.01" v-model.number="volume" @input="applyVolume" style="width:140px"/>
            <select class="form-select form-select-sm" v-model.number="rate" @change="applyRate" style="width:110px">
              <option :value="0.75">0.75√ó</option>
              <option :value="1">1.00√ó</option>
              <option :value="1.25">1.25√ó</option>
              <option :value="1.5">1.50√ó</option>
            </select>
          </div>

          <div v-if="needUserGesture" class="alert alert-info mt-3 py-2 px-3">
            El navegador bloque√≥ el autoplay. Haz clic en <a href="#" @click.prevent="enableAudio">activar audio</a>.
          </div>

          <audio id="audio" :src="audioSrc" preload="auto" playsinline></audio>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm">
        <div class="card-body">
          <h5 class="card-title">Cola (pendientes)</h5>
          <div v-if="!queue.length" class="list-group-item text-muted">Vac√≠o</div>
          <div v-for="t in queue" :key="t.id" class="d-flex justify-content-between align-items-center py-2 border-bottom">
            <div class="d-flex align-items-center gap-3">
              <img :src="thumb(t.id)" class="queue-thumb" :alt="t.title">
              <div>
                <div class="text-truncate" style="max-width:360px">{{ t.title }}</div>
                <div class="text-muted small">
                  <span v-if="t._ready===true">{{ mmss(t.seconds) }}</span>
                  <span v-else class="text-warning"><span class="spinner-border spinner-border-sm me-1"></span>Descargando‚Ä¶</span>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

</div>

<script>
new Vue({
  el: '#app',
  data: {
    urlOrId: '',
    busy: false,
    adding: [],
    ws: null,
    connected: false,
    state: { current: null, position: 0, positionLabel: '0:00', duration: 0, durationLabel: '0:00', playing: false },
    queue: [],
    volume: Number(localStorage.getItem('vol') ?? 0.8),
    muted: false,
    rate: Number(localStorage.getItem('rate') ?? 1),
    needUserGesture: false,
    pollTimer: null,
    // B√∫squeda
    searchQuery: '',
    searching: false,
    searchResults: []
  },
  computed: {
    audioSrc() { return this.state.current ? `/stream/${this.state.current.id}` : ''; }
  },
  methods: {
    thumb(id){ return `https://i.ytimg.com/vi/${id}/hqdefault.jpg`; },
    mmss(s){ s=Math.max(0,Math.floor(s||0)); return `${Math.floor(s/60)}:${String(s%60).padStart(2,'0')}`; },

    proto(){ return location.protocol==='https:'?'wss':'ws'; },
    connectWS(){
      this.ws = new WebSocket(`${this.proto()}://${location.host}/ws`);
      this.ws.onopen = () => { this.connected = true; };
      this.ws.onclose = () => { this.connected = false; setTimeout(this.connectWS, 1000); };
      this.ws.onmessage = (ev) => {
        const {type, data} = JSON.parse(ev.data);
        if (type === 'state') {
          this.state = Object.assign(this.state, data);
          this.queue = data.queue || [];
          this.syncAudio(); // MISMA l√≥gica que tu front que s√≠ suena
        } else if (type === 'queue:update') {
          this.queue = data || [];
          this.markQueueReadiness();
        } else if (type === 'player:tick') {
          this.state.position = data.position;
          this.state.positionLabel = data.positionLabel;
          this.syncAudio(); // MISMA l√≥gica
        }
      };
    },
    wsSend(type, data){ if (this.ws && this.ws.readyState===1) this.ws.send(JSON.stringify({type, ...data})); },

    async addAndEnqueue(){
      if (!this.urlOrId) return;
      const show = this.urlOrId.length>20? this.urlOrId.slice(0,20)+'‚Ä¶' : this.urlOrId;
      this.adding.push({show});
      this.busy = true;
      try{
        await fetch('/api/tracks', {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify({urlOrId:this.urlOrId, enqueue:true})
        });
        this.urlOrId='';
        // Refrescos programados (por si el WS tarda)
        setTimeout(this.refreshQueue, 500);
        setTimeout(this.refreshQueue, 2000);
        setTimeout(this.refreshQueue, 5000);
      }catch(e){
        alert('Error agregando: '+e);
      }finally{
        this.busy=false;
        this.adding.shift();
      }
    },

    refreshQueue(){
      fetch('/api/queue').then(r=>r.json()).then(q=>{
        this.queue=q||[];
        this.markQueueReadiness();
      }).catch(()=>{});
      this.wsSend('state:get',{}); // pedir estado por WS tambi√©n
    },

    syncAudio(){
      const audio = document.getElementById('audio');
      if (!this.state.current) { audio.pause(); return; }
      if (audio.src !== location.origin + this.audioSrc) audio.src = this.audioSrc;
      const drift = Math.abs((audio.currentTime || 0) - (this.state.position || 0));
      if (drift > 0.5) audio.currentTime = this.state.position || 0;
      if (this.state.playing && audio.paused) audio.play().catch(()=>{ this.needUserGesture = true; });
      if (!this.state.playing && !audio.paused) audio.pause();
    },

    onSeek(e){
      const at = Number(e.target.value || 0);
      this.wsSend('player:seek', { at });
    },

    applyVolume(){
      // Evita ‚Äúsilencio por localStorage‚Äù: si llega 0, sube a 0.1
      if (this.volume <= 0) this.volume = 0.1;
      document.getElementById('audio').volume = this.volume;
      localStorage.setItem('vol', String(this.volume));
      if (this.volume>0 && this.muted) this.muted=false;
    },
    toggleMute(){ this.muted=!this.muted; document.getElementById('audio').muted=this.muted; },

    applyRate(){
      // Evita playbackRate inv√°lido (0): clamp a [0.5, 2], por defecto 1
      if (!this.rate || this.rate<0.5) this.rate = 1;
      document.getElementById('audio').playbackRate = this.rate;
      localStorage.setItem('rate', String(this.rate));
    },

    async enableAudio(){
      try{ await document.getElementById('audio').play(); this.needUserGesture=false; }
      catch{ this.needUserGesture=true; }
    },

    // Marca si el stream ya est√° listo probando 1 byte (sin tocar backend)
    async markQueueReadiness(){
      const tasks = this.queue.map(async t=>{
        try{
          const r = await fetch(`/stream/${t.id}`, { headers:{ Range:'bytes=0-0' } });
          t._ready = (r.status===206 || r.status===200);
        }catch{ t._ready = false; }
        return t;
      });
      await Promise.allSettled(tasks);
      this.$forceUpdate();
    },

    // ---- M√©todos de b√∫squeda ----
    async searchMusic(){
      if (!this.searchQuery.trim()) return;
      this.searching = true;
      try{
        const response = await fetch(`/api/search?q=${encodeURIComponent(this.searchQuery)}&maxResults=10`);
        const data = await response.json();
        this.searchResults = data.items || [];
      }catch(e){
        alert('Error buscando: ' + e.message);
        this.searchResults = [];
      }finally{
        this.searching = false;
      }
    },

    clearSearch(){
      this.searchResults = [];
      this.searchQuery = '';
    },

    async playNow(videoId){
      // Agrega y reproduce inmediatamente
      try{
        const response = await fetch('/api/tracks', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({urlOrId: videoId, enqueue: true})
        });
        if (response.ok) {
          // Salta a la siguiente canci√≥n (que ser√° la que acabamos de agregar)
          setTimeout(() => {
            this.wsSend('player:next', {});
          }, 1000);
        }
      }catch(e){
        alert('Error reproduciendo: ' + e.message);
      }
    },

    async addToQueue(videoId){
      // Solo agrega a la cola
      this.adding.push({show: videoId});
      try{
        await fetch('/api/tracks', {
          method:'POST',
          headers:{'Content-Type':'application/json'},
          body: JSON.stringify({urlOrId: videoId, enqueue: true})
        });
        setTimeout(this.refreshQueue, 500);
      }catch(e){
        alert('Error agregando: ' + e.message);
      }finally{
        this.adding.shift();
      }
    }
  },
  mounted(){
    // Normaliza valores
    if (!this.rate || this.rate<0.5) this.rate = 1;
    if (this.volume<=0) this.volume = 0.8;

    // Aplica al <audio>
    const audio = document.getElementById('audio');
    audio.volume = this.volume;
    audio.playbackRate = this.rate;
    audio.addEventListener('canplay', ()=>{ if (this.state.playing) this.enableAudio(); });

    // Conecta WS y arranca polls
    this.connectWS();
    this.pollTimer = setInterval(this.refreshQueue, 4000);
    // Primeros refrescos
    this.refreshQueue();
    setTimeout(this.refreshQueue, 1200);
    setTimeout(this.refreshQueue, 3000);
  },
  beforeDestroy(){ if (this.pollTimer) clearInterval(this.pollTimer); }
});
</script>
</body>
</html>
